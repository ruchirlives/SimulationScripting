<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulation App</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@codemirror/view/dist/style/codemirror.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@codemirror/theme-one-dark/dist/index.min.css">
    <style>
        /* Add your custom styles here */
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto py-8">
        <h1 class="text-3xl font-bold mb-6">Simulation File Uploader</h1>

        <!-- File upload areas -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="file-upload-area p-4 border-2 border-dashed rounded-lg bg-white shadow-sm" data-target="yaml_file">
                <input id="yaml_file" type="file" class="hidden" accept=".yaml, .yml">
                <div class="file-info text-sm text-gray-500"></div>
                <button type="button" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-md shadow hover:bg-indigo-700">
                    Upload YAML File
                </button>
            </div>
            <div class="file-upload-area p-4 border-2 border-dashed rounded-lg bg-white shadow-sm" data-target="fcrdata_file">
                <input id="fcrdata_file" type="file" class="hidden" accept=".yaml, .yml">
                <div class="file-info text-sm text-gray-500"></div>
                <button type="button" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-md shadow hover:bg-indigo-700">
                    Upload FCR Data File
                </button>
            </div>
            <div class="file-upload-area p-4 border-2 border-dashed rounded-lg bg-white shadow-sm" data-target="supportdata_file">
                <input id="supportdata_file" type="file" class="hidden" accept=".yaml, .yml">
                <div class="file-info text-sm text-gray-500"></div>
                <button type="button" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-md shadow hover:bg-indigo-700">
                    Upload Support Data File
                </button>
            </div>
        </div>

        <!-- Simulation form -->
        <form id="simulationForm" class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4">Simulation Parameters</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="steps" class="block text-sm font-medium text-gray-700 mb-1">Number of Steps</label>
                    <input type="number" id="steps" name="steps" min="1" value="10" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
            <div class="mt-4">
                <button type="submit" id="submitBtn" class="w-full px-4 py-2 bg-green-600 text-white rounded-md shadow hover:bg-green-700">
                    ðŸš€ Run Simulation
                </button>
            </div>
        </form>

        <!-- Response area -->
        <div id="responseArea" class="hidden">
            <h2 class="text-xl font-semibold mb-4">Simulation Results</h2>
            <div id="tabContainer" class="mb-4">
                <button type="button" class="tab-btn px-4 py-2 mr-2 rounded-md font-medium" onclick="showTab('summary')">
                    Summary
                </button>
                <button type="button" class="tab-btn px-4 py-2 mr-2 rounded-md font-medium" onclick="showTab('raw-json')">
                    Raw JSON
                </button>
            </div>
            <div id="loadingIndicator" class="hidden text-center mb-4">
                <svg class="animate-spin h-5 w-5 mx-auto text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4.293 12.293a1 1 0 011.414 0L12 18.586l6.293-6.293a1 1 0 011.414 1.414l-7 7a1 1 0 01-1.414 0l-7-7a1 1 0 010-1.414z"></path>
                </svg>
            </div>
            <pre id="responseContent" class="bg-gray-50 p-4 rounded-md overflow-x-auto text-sm"></pre>
        </div>

        <!-- YAML Editor Section -->
        <div class="mt-4">
            <label for="yaml_file_editor" class="block mb-2 font-semibold text-slate-600">Edit YAML Content</label>
            <div id="yaml_file_editor" class="yaml-editor w-full p-3 border border-gray-300 rounded-md font-mono text-sm" style="min-height: 10rem;"></div>
            <button type="button" class="download-file mt-2 text-indigo-500 underline" data-target="yaml_file">Download YAML</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@codemirror/basic-setup/dist/basic-setup.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@codemirror/lang-yaml/dist/lang-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@codemirror/autocomplete/dist/autocomplete.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@codemirror/view/dist/view.min.js"></script>
    <script>
          const editors = {};
          // File upload handling
          document.querySelectorAll('.file-upload-area').forEach(area => {
              const input = area.querySelector('input[type="file"]');
              const info = area.querySelector('.file-info');

              area.addEventListener('click', () => input.click());

              // Drag and drop
              area.addEventListener('dragover', (e) => {
                  e.preventDefault();
                  area.classList.add('border-indigo-500', 'bg-indigo-50');
              });

              area.addEventListener('dragleave', () => {
                  area.classList.remove('border-indigo-500', 'bg-indigo-50');
              });

              area.addEventListener('drop', (e) => {
                  e.preventDefault();
                  area.classList.remove('border-indigo-500', 'bg-indigo-50');

                  const files = e.dataTransfer.files;
                  if (files.length > 0) {
                      input.files = files;
                      updateFileInfo(input, info);
                  }
              });

              input.addEventListener('change', () => {
                  updateFileInfo(input, info);
              });
          });

          // Add clear file functionality
          document.querySelectorAll('.clear-file').forEach(btn => {
              btn.addEventListener('click', (e) => {
                  e.stopPropagation();
                  const targetId = btn.getAttribute('data-target');
                  const area = document.querySelector(`.file-upload-area[data-target="${targetId}"]`);
                  const input = document.getElementById(targetId);
                  const info = document.getElementById(targetId + '_info');

                  // Clear file input and localStorage
                  input.value = '';
                  localStorage.removeItem('file_' + targetId);
                  info.classList.add('hidden');
                  area.classList.remove('border-indigo-500', 'bg-indigo-50');
                  if (editors[targetId]) {
                      editors[targetId].dispatch({
                          changes: {from: 0, to: editors[targetId].state.doc.length, insert: ''}
                      });
                  }
              });
          });

          function initializeEditors() {
              console.log("Loading saved files from localStorage");
              const ids = ['yaml_file', 'fcrdata_file', 'supportdata_file'];
              const keywords = ['item','description','type','budget','step','amount','date','term','projects','transactions','support'];
              const hint = autocompletion({
                  override: [ctx => {
                      let w = ctx.matchBefore(/\w*/);
                      if (!w || (w.from == w.to && !ctx.explicit)) return null;
                      return {from: w.from, options: keywords.map(k => ({label:k, type:'keyword'}))};
                  }]
              });

              ids.forEach(id => {
                  let data = null;
                  try {
                      const stored = localStorage.getItem('file_' + id);
                      if (stored) data = JSON.parse(stored);
                  } catch (error) {
                      console.error(`Error loading ${id} from localStorage:`, error);
                  }

                  const area = document.querySelector(`.file-upload-area[data-target="${id}"]`);
                  const info = document.getElementById(id + '_info');
                  const parent = document.getElementById(id + '_editor');

                  if (data && info) {
                      info.innerHTML = `Selected: ${data.name} (${(data.size/1024).toFixed(1)} KB) <button type="button" class="clear-file ml-2 text-red-500 hover:text-red-700" data-target="${id}">âœ• Clear</button>`;
                      info.classList.remove('hidden');
                      const clearBtn = info.querySelector('.clear-file');
                      if (clearBtn) {
                          clearBtn.addEventListener('click', (e) => {
                              e.stopPropagation();
                              console.log(`Clearing stored file: ${id}`);
                              localStorage.removeItem('file_' + id);
                              info.classList.add('hidden');
                              if (area) area.classList.remove('border-indigo-500', 'bg-indigo-50');
                              if (editors[id]) editors[id].dispatch({changes:{from:0,to:editors[id].state.doc.length,insert:''}});
                          });
                      }
                  }

                  // During initialization
                  const view = new EditorView({
                      doc: data && data.content ? data.content : '',
                      extensions: [
                          basicSetup,
                          yaml(),
                          hint,
                          EditorView.editable.of(true) // Ensure editor is editable
                      ],
                      parent
                  });
                  editors[id] = view;

              });

              // Download buttons
              document.querySelectorAll('.download-file').forEach(btn => {
                  btn.addEventListener('click', () => {
                      const id = btn.getAttribute('data-target');
                      const storedStr = localStorage.getItem('file_' + id);
                      if (storedStr) {
                          const f = JSON.parse(storedStr);
                          const blob = new Blob([f.content || ''], { type: 'text/yaml' });
                          const url = URL.createObjectURL(blob);
                          const a = document.createElement('a');
                          a.href = url;
                          a.download = f.name || id + '.yaml';
                          a.click();
                          URL.revokeObjectURL(url);
                      }
                  });
              });
          }

          // Restore persisted files on load and initialise CodeMirror
          if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', initializeEditors);
          } else {
              initializeEditors();
          }

          function updateFileInfo(input, info) {
              if (input.files.length > 0) {
                  const file = input.files[0];
                  info.innerHTML = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB) <button type="button" class="clear-file ml-2 text-red-500 hover:text-red-700" data-target="${input.id}">âœ• Clear</button>`;
                  info.classList.remove('hidden');
                  
                  // Add event listener to the newly created clear button
                  const clearBtn = info.querySelector('.clear-file');
                  if (clearBtn) {
                      clearBtn.addEventListener('click', (e) => {
                          e.stopPropagation();
                          console.log(`Clearing file: ${input.id}`);
                          input.value = '';
                          localStorage.removeItem('file_' + input.id);
                          info.classList.add('hidden');
                          const area = document.querySelector(`.file-upload-area[data-target="${input.id}"]`);
                          if (area) {
                              area.classList.remove('border-indigo-500', 'bg-indigo-50');
                          }
                      });
                  }

                  // Persist file content
                  const reader = new FileReader();
                  reader.onload = (event) => {
                      try {
                          const content = event.target.result;
                          const payload = { name: file.name, size: file.size, type: file.type, content };
                          localStorage.setItem('file_' + input.id, JSON.stringify(payload));
                          if (editors[input.id]) {
                              // Replace all content in the editor with the loaded file content
                              editors[input.id].dispatch({
                                  changes: { from: 0, to: editors[input.id].state.doc.length, insert: content }
                              });
                          } else {
                              // Fallback: set the text content of the editor div if CodeMirror is not initialized
                              const editorDiv = document.getElementById(input.id + '_editor');
                              if (editorDiv) editorDiv.textContent = content;
                          }
                          console.log(`File ${file.name} saved to localStorage for ${input.id} (${content.length} bytes)`);
                      } catch (error) {
                          console.error(`Error saving file ${file.name} to localStorage:`, error);
                      }
                  };
                  reader.readAsText(file);
              } else {
                  info.classList.add('hidden');
              }
          }

          // Tab handling
          function showTab(tabId) {
              // Hide all tab contents
              document.querySelectorAll('.tab-content').forEach(content => {
                  content.classList.add('hidden');
                  content.classList.remove('block');
              });

              // Remove active class from all tab buttons
              document.querySelectorAll('.tab-btn').forEach(btn => {
                  btn.classList.remove('active', 'border-b-indigo-500', 'text-indigo-500', 'bg-blue-50');
                  btn.classList.add('border-b-transparent', 'text-gray-600');
              });

              // Show selected tab content
              document.getElementById(tabId).classList.remove('hidden');
              document.getElementById(tabId).classList.add('block');

              // Find and activate the correct button
              const buttons = document.querySelectorAll('.tab-btn');
              buttons.forEach(btn => {
                  if (btn.getAttribute('onclick').includes(tabId)) {
                      btn.classList.add('active', 'border-b-indigo-500', 'text-indigo-500', 'bg-blue-50');
                      btn.classList.remove('border-b-transparent', 'text-gray-600');
                  }
              });
          }

          // Table rendering functions
          function formatCurrency(value) {
              if (typeof value === 'number') {
                  return new Intl.NumberFormat('en-GB', {
                      style: 'currency',
                      currency: 'GBP',
                      minimumFractionDigits: 0,
                      maximumFractionDigits: 0
                  }).format(value);
              }
              return value;
          }

          function formatNumber(value) {
              if (typeof value === 'number') {
                  return new Intl.NumberFormat('en-GB', {
                      minimumFractionDigits: 2,
                      maximumFractionDigits: 2
                  }).format(value);
              }
              return value;
          }

          function renderTable(tableId, data, formatters = {}) {
              const table = document.getElementById(tableId);
              const headerRow = document.getElementById(tableId + 'Header');
              const tbody = document.getElementById(tableId + 'Body');

              if (!data || data.length === 0) {
                  headerRow.innerHTML = '<th class="p-3 text-left font-semibold border-b-2 border-gray-300">No data available</th>';
                  tbody.innerHTML = '';
                  return;
              }

              // Get all unique keys from the data
              let keys = [...new Set(data.flatMap(Object.keys))];
              // Reorder columns for budget table: description, item, type first, then step columns
              if (tableId === 'budgetTable') {
                  const fixed = ['item','description', 'type'];
                  const stepCols = keys.filter(k => !fixed.includes(k)).sort((a, b) => {
                      const na = parseInt((a.match(/\d+/) || [])[0]);
                      const nb = parseInt((b.match(/\d+/) || [])[0]);
                      return (isNaN(na) ? 0 : na) - (isNaN(nb) ? 0 : nb);
                  });
                  keys = [...fixed, ...stepCols];
              }

              // Create header
              headerRow.innerHTML = keys.map(key =>
                  `<th class="p-3 text-left font-semibold border-b-2 border-gray-300">${key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ')}</th>`
              ).join('');

              // Create rows
              tbody.innerHTML = data.map(row => {
                  return '<tr class="even:bg-gray-50 hover:bg-blue-50">' + keys.map(key => {
                      let value = row[key] || '';
                      let cellClass = 'p-3 border-b border-gray-100 align-top';
                      let originalValue = value; // Keep original for comparison

                      // Apply formatters
                      if (formatters[key]) {
                          value = formatters[key](value);
                          cellClass += ' text-right font-mono font-medium';
                          if (key.includes('budget') || key.includes('amount') || key.includes('cost')) {
                              cellClass += ' text-green-600';
                              // Check original numeric value, not formatted string
                              if (typeof originalValue === 'number' && originalValue < 0) {
                                  cellClass += ' text-red-600';
                              }
                          }
                      }

                      return `<td class="${cellClass}">${value}</td>`;
                  }).join('') + '</tr>';
              }).join('');
          }

          function createPivotTable(budgetData) {
              if (!budgetData || budgetData.length === 0) return [];

              // Group by item
              const grouped = {};
              budgetData.forEach(row => {
                  const item = row.item || 'Unknown';
                  if (!grouped[item]) {
                      grouped[item] = {
                          item: item,
                          description: row.description || '',
                          type: row.type || ''
                      };
                  }

                  // Add step-based budget columns
                  const step = `Step ${row.step || 0}`;
                  grouped[item][step] = (grouped[item][step] || 0) + (row.budget || 0);
              });

              return Object.values(grouped);
          }

          // Form submission
          document.getElementById('simulationForm').addEventListener('submit', async (e) => {
              e.preventDefault();

              // Build FormData with editor content
              const formData = new FormData();
              let hasRequiredFiles = false;

              try {
                  // Check for main simulation file (required)
                  const mainStored = localStorage.getItem('file_yaml_file');
                  const mainMeta = mainStored ? JSON.parse(mainStored) : { name: 'yaml_file.yaml', type: 'text/yaml' };
                  const mainContent = editors['yaml_file'].state.doc.toString();
                  if (mainContent.trim().length > 0) {
                      formData.append('yaml_file', new File([mainContent], mainMeta.name, { type: mainMeta.type }));
                      hasRequiredFiles = true;
                      localStorage.setItem('file_yaml_file', JSON.stringify({ ...mainMeta, size: mainContent.length, content: mainContent }));
                  }

                  // Only proceed if we have the required yaml file
                  if (!hasRequiredFiles) {
                      alert("Please upload a simulation YAML file");
                      throw new Error("Missing required simulation YAML file");
                  }

                  // Add optional files
                  ['fcrdata_file', 'supportdata_file'].forEach(id => {
                      const stored = localStorage.getItem('file_' + id);
                      const meta = stored ? JSON.parse(stored) : { name: id + '.yaml', type: 'text/yaml' };
                      const content = editors[id].state.doc.toString();
                      if (content.trim().length > 0) {
                          formData.append(id, new File([content], meta.name, { type: meta.type }));
                          localStorage.setItem('file_' + id, JSON.stringify({ ...meta, size: content.length, content }));
                      }
                  });

                  // Append steps
                  formData.append('steps', document.getElementById('steps').value);
              } catch (error) {
                  console.error("Error preparing form data:", error);
                  submitBtn.disabled = false;
                  submitBtn.textContent = 'ðŸš€ Run Simulation';
                  return; // Stop form submission
              }

              const submitBtn = document.getElementById('submitBtn');
              const responseArea = document.getElementById('responseArea');
              const tabContainer = document.getElementById('tabContainer');
              const loadingIndicator = document.getElementById('loadingIndicator');
              const responseContent = document.getElementById('responseContent');

              // Show loading state
              submitBtn.disabled = true;
              submitBtn.textContent = 'â³ Running...';
              responseArea.classList.remove('hidden');
              responseArea.classList.add('block');
              tabContainer.classList.add('hidden');
              loadingIndicator.classList.remove('hidden');

              try {
                  const response = await fetch('/', {
                      method: 'POST',
                      body: formData
                  });

                  const result = await response.json();

                  if (response.ok) {
                      // Show tab container
                      tabContainer.classList.remove('hidden');

                      // Render tables
                      const budgetFormatters = {
                          budget: formatCurrency,
                          step: formatNumber
                      };

                      const projectFormatters = {
                          budget: formatCurrency,
                          cost: formatCurrency,
                          income: formatCurrency,
                          term: formatNumber
                      };

                      const transactionFormatters = {
                          amount: formatCurrency,
                          balance: formatCurrency,
                          date: formatNumber
                      };

                      // Use pivot data if available, otherwise create it from budget data
                      let budgetTableData;
                      if (result.budget_pivot && result.budget_pivot.length > 0) {
                          budgetTableData = result.budget_pivot;

                          // Create formatters for step columns
                          const pivotFormatters = {};
                          if (budgetTableData.length > 0) {
                              Object.keys(budgetTableData[0]).forEach(key => {
                                  if (key.match(/^\d+$/) || key.includes('Step')) {
                                      pivotFormatters[key] = formatCurrency;
                                  }
                              });
                          }

                          renderTable('budgetTable', budgetTableData, pivotFormatters);
                      } else {
                          // Fallback: create pivot table from budget data
                          budgetTableData = createPivotTable(result.budget || []);

                          // Find all step columns for pivot table
                          const stepColumns = {};
                          (result.budget || []).forEach(row => {
                              const step = `Step ${row.step || 0}`;
                              stepColumns[step] = formatCurrency;
                          });

                          const pivotFormatters = {
                              ...stepColumns
                          };

                          renderTable('budgetTable', budgetTableData, pivotFormatters);
                      }

                      renderTable('projectsTable', result.projects || [], projectFormatters);
                      renderTable('transactionsTable', result.transactions || [], transactionFormatters);

                      // Show raw JSON
                      responseContent.textContent = JSON.stringify(result, null, 2);
                      responseContent.classList.remove('text-red-500');
                      responseContent.classList.add('text-green-600');

                  } else {
                      // Show error in raw JSON tab
                      tabContainer.classList.remove('hidden');
                      showTab('raw-json');
                      responseContent.textContent = JSON.stringify(result, null, 2);
                      responseContent.classList.remove('text-green-600');
                      responseContent.classList.add('text-red-500');
                  }

              } catch (error) {
                  tabContainer.classList.remove('hidden');
                  showTab('raw-json');
                  responseContent.textContent = `Error: ${error.message}`;
                  responseContent.classList.remove('text-green-600');
                  responseContent.classList.add('text-red-500');
              } finally {
                  // Reset button state
                  submitBtn.disabled = false;
                  submitBtn.textContent = 'ðŸš€ Run Simulation';
                  loadingIndicator.classList.add('hidden');
              }
          });
    </script>
</body>
</html>
