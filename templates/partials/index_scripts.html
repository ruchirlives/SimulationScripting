    <script>
          // File upload handling
          document.querySelectorAll('.file-upload-area').forEach(area => {
              const input = area.querySelector('input[type="file"]');
              const info = area.querySelector('.file-info');

              area.addEventListener('click', () => input.click());

              // Drag and drop
              area.addEventListener('dragover', (e) => {
                  e.preventDefault();
                  area.classList.add('border-indigo-500', 'bg-indigo-50');
              });

              area.addEventListener('dragleave', () => {
                  area.classList.remove('border-indigo-500', 'bg-indigo-50');
              });

              area.addEventListener('drop', (e) => {
                  e.preventDefault();
                  area.classList.remove('border-indigo-500', 'bg-indigo-50');

                  const files = e.dataTransfer.files;
                  if (files.length > 0) {
                      input.files = files;
                      updateFileInfo(input, info);
                  }
              });

              input.addEventListener('change', () => {
                  updateFileInfo(input, info);
              });
          });

          // Add clear file functionality
          document.querySelectorAll('.clear-file').forEach(btn => {
              btn.addEventListener('click', (e) => {
                  e.stopPropagation();
                  const targetId = btn.getAttribute('data-target');
                  const area = document.querySelector(`.file-upload-area[data-target="${targetId}"]`);
                  const input = document.getElementById(targetId);
                  const info = document.getElementById(targetId + '_info');

                  // Clear file input and localStorage
                  input.value = '';
                  localStorage.removeItem('file_' + targetId);
                  info.classList.add('hidden');
                  area.classList.remove('border-indigo-500', 'bg-indigo-50');
              });
          });

          // Restore persisted files on load
          document.addEventListener('DOMContentLoaded', () => {
              console.log("Loading saved files from localStorage");
              ['yaml_file', 'fcrdata_file', 'supportdata_file'].forEach(id => {
                  try {
                      const stored = localStorage.getItem('file_' + id);
                      if (stored) {
                          const data = JSON.parse(stored);
                          console.log(`Found stored file: ${id}, ${data.name}, ${data.content ? data.content.length + ' bytes' : 'missing content'}`);
                          const area = document.querySelector(`.file-upload-area[data-target="${id}"]`);
                          const info = document.getElementById(id + '_info');
                          
                          if (info) {
                              info.innerHTML = `Selected: ${data.name} (${(data.size/1024).toFixed(1)} KB) <button type="button" class="clear-file ml-2 text-red-500 hover:text-red-700" data-target="${id}">✕ Clear</button>`;
                              info.classList.remove('hidden');
                              
                              // Add event listener to the clear button
                              const clearBtn = info.querySelector('.clear-file');
                              if (clearBtn) {
                                  clearBtn.addEventListener('click', (e) => {
                                      e.stopPropagation();
                                      console.log(`Clearing stored file: ${id}`);
                                      localStorage.removeItem('file_' + id);
                                      info.classList.add('hidden');
                                      if (area) {
                                          area.classList.remove('border-indigo-500', 'bg-indigo-50');
                                      }
                                  });
                              }
                          }
                          
                          if (area) {
                              area.classList.add('border-indigo-500', 'bg-indigo-50');
                          }
                      }
                  } catch (error) {
                      console.error(`Error loading ${id} from localStorage:`, error);
                  }
              });
          });

          function updateFileInfo(input, info) {
              if (input.files.length > 0) {
                  const file = input.files[0];
                  info.innerHTML = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB) <button type="button" class="clear-file ml-2 text-red-500 hover:text-red-700" data-target="${input.id}">✕ Clear</button>`;
                  info.classList.remove('hidden');
                  
                  // Add event listener to the newly created clear button
                  const clearBtn = info.querySelector('.clear-file');
                  if (clearBtn) {
                      clearBtn.addEventListener('click', (e) => {
                          e.stopPropagation();
                          console.log(`Clearing file: ${input.id}`);
                          input.value = '';
                          localStorage.removeItem('file_' + input.id);
                          info.classList.add('hidden');
                          const area = document.querySelector(`.file-upload-area[data-target="${input.id}"]`);
                          if (area) {
                              area.classList.remove('border-indigo-500', 'bg-indigo-50');
                          }
                      });
                  }

                  // Persist file content
                  const reader = new FileReader();
                  reader.onload = (event) => {
                      try {
                          const content = event.target.result;
                          const payload = { name: file.name, size: file.size, type: file.type, content };
                          localStorage.setItem('file_' + input.id, JSON.stringify(payload));
                          console.log(`File ${file.name} saved to localStorage for ${input.id} (${content.length} bytes)`);
                      } catch (error) {
                          console.error(`Error saving file ${file.name} to localStorage:`, error);
                      }
                  };
                  reader.readAsText(file);
              } else {
                  info.classList.add('hidden');
              }
          }

          // Tab handling
          function showTab(tabId) {
              // Hide all tab contents
              document.querySelectorAll('.tab-content').forEach(content => {
                  content.classList.add('hidden');
                  content.classList.remove('block');
              });

              // Remove active class from all tab buttons
              document.querySelectorAll('.tab-btn').forEach(btn => {
                  btn.classList.remove('active', 'border-b-indigo-500', 'text-indigo-500', 'bg-blue-50');
                  btn.classList.add('border-b-transparent', 'text-gray-600');
              });

              // Show selected tab content
              document.getElementById(tabId).classList.remove('hidden');
              document.getElementById(tabId).classList.add('block');

              // Find and activate the correct button
              const buttons = document.querySelectorAll('.tab-btn');
              buttons.forEach(btn => {
                  if (btn.getAttribute('onclick').includes(tabId)) {
                      btn.classList.add('active', 'border-b-indigo-500', 'text-indigo-500', 'bg-blue-50');
                      btn.classList.remove('border-b-transparent', 'text-gray-600');
                  }
              });
          }

          // Table rendering functions
          function formatCurrency(value) {
              if (typeof value === 'number') {
                  return new Intl.NumberFormat('en-GB', {
                      style: 'currency',
                      currency: 'GBP',
                      minimumFractionDigits: 0,
                      maximumFractionDigits: 0
                  }).format(value);
              }
              return value;
          }

          function formatNumber(value) {
              if (typeof value === 'number') {
                  return new Intl.NumberFormat('en-GB', {
                      minimumFractionDigits: 2,
                      maximumFractionDigits: 2
                  }).format(value);
              }
              return value;
          }

          function renderTable(tableId, data, formatters = {}) {
              const table = document.getElementById(tableId);
              const headerRow = document.getElementById(tableId + 'Header');
              const tbody = document.getElementById(tableId + 'Body');

              if (!data || data.length === 0) {
                  headerRow.innerHTML = '<th class="p-3 text-left font-semibold border-b-2 border-gray-300">No data available</th>';
                  tbody.innerHTML = '';
                  return;
              }

              // Get all unique keys from the data
              let keys = [...new Set(data.flatMap(Object.keys))];
              // Reorder columns for budget table: description, item, type first, then step columns
              if (tableId === 'budgetTable') {
                  const fixed = ['item','description', 'type'];
                  const stepCols = keys.filter(k => !fixed.includes(k)).sort((a, b) => {
                      const na = parseInt((a.match(/\d+/) || [])[0]);
                      const nb = parseInt((b.match(/\d+/) || [])[0]);
                      return (isNaN(na) ? 0 : na) - (isNaN(nb) ? 0 : nb);
                  });
                  keys = [...fixed, ...stepCols];
              }

              // Create header
              headerRow.innerHTML = keys.map(key =>
                  `<th class="p-3 text-left font-semibold border-b-2 border-gray-300">${key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ')}</th>`
              ).join('');

              // Create rows
              tbody.innerHTML = data.map(row => {
                  return '<tr class="even:bg-gray-50 hover:bg-blue-50">' + keys.map(key => {
                      let value = row[key] || '';
                      let cellClass = 'p-3 border-b border-gray-100 align-top';
                      let originalValue = value; // Keep original for comparison

                      // Apply formatters
                      if (formatters[key]) {
                          value = formatters[key](value);
                          cellClass += ' text-right font-mono font-medium';
                          if (key.includes('budget') || key.includes('amount') || key.includes('cost')) {
                              cellClass += ' text-green-600';
                              // Check original numeric value, not formatted string
                              if (typeof originalValue === 'number' && originalValue < 0) {
                                  cellClass += ' text-red-600';
                              }
                          }
                      }

                      return `<td class="${cellClass}">${value}</td>`;
                  }).join('') + '</tr>';
              }).join('');
          }

          function createPivotTable(budgetData) {
              if (!budgetData || budgetData.length === 0) return [];

              // Group by item
              const grouped = {};
              budgetData.forEach(row => {
                  const item = row.item || 'Unknown';
                  if (!grouped[item]) {
                      grouped[item] = {
                          item: item,
                          description: row.description || '',
                          type: row.type || ''
                      };
                  }

                  // Add step-based budget columns
                  const step = `Step ${row.step || 0}`;
                  grouped[item][step] = (grouped[item][step] || 0) + (row.budget || 0);
              });

              return Object.values(grouped);
          }

          // Form submission
          document.getElementById('simulationForm').addEventListener('submit', async (e) => {
              e.preventDefault();

              // Build FormData with persisted files
              const formData = new FormData();
              let hasRequiredFiles = false;

              try {
                  // Check for main simulation file (required)
                  const mainYamlStored = localStorage.getItem('file_yaml_file');
                  if (mainYamlStored) {
                      const mainFile = JSON.parse(mainYamlStored);
                      if (mainFile && mainFile.content) {
                          console.log(`Using stored yaml_file: ${mainFile.name} (${mainFile.content.length} bytes)`);
                          formData.append('yaml_file', new File([mainFile.content], mainFile.name, { type: mainFile.type }));
                          hasRequiredFiles = true;
                      }
                  }

                  // Only proceed if we have the required yaml file
                  if (!hasRequiredFiles) {
                      alert("Please upload a simulation YAML file");
                      throw new Error("Missing required simulation YAML file");
                  }

                  // Add optional files
                  ['fcrdata_file', 'supportdata_file'].forEach(id => {
                      const stored = localStorage.getItem('file_' + id);
                      if (stored) {
                          const f = JSON.parse(stored);
                          if (f && f.content) {
                              console.log(`Using stored ${id}: ${f.name} (${f.content.length} bytes)`);
                              formData.append(id, new File([f.content], f.name, { type: f.type }));
                          }
                      }
                  });

                  // Append steps
                  formData.append('steps', document.getElementById('steps').value);
              } catch (error) {
                  console.error("Error preparing form data:", error);
                  submitBtn.disabled = false;
                  submitBtn.textContent = '🚀 Run Simulation';
                  return; // Stop form submission
              }

              const submitBtn = document.getElementById('submitBtn');
              const responseArea = document.getElementById('responseArea');
              const tabContainer = document.getElementById('tabContainer');
              const loadingIndicator = document.getElementById('loadingIndicator');
              const responseContent = document.getElementById('responseContent');

              // Show loading state
              submitBtn.disabled = true;
              submitBtn.textContent = '⏳ Running...';
              responseArea.classList.remove('hidden');
              responseArea.classList.add('block');
              tabContainer.classList.add('hidden');
              loadingIndicator.classList.remove('hidden');

              try {
                  const response = await fetch('/simulate', {
                      method: 'POST',
                      body: formData
                  });

                  const result = await response.json();

                  if (response.ok) {
                      // Show tab container
                      tabContainer.classList.remove('hidden');

                      // Render tables
                      const budgetFormatters = {
                          budget: formatCurrency,
                          step: formatNumber
                      };

                      const projectFormatters = {
                          budget: formatCurrency,
                          cost: formatCurrency,
                          income: formatCurrency,
                          term: formatNumber
                      };

                      const transactionFormatters = {
                          amount: formatCurrency,
                          balance: formatCurrency,
                          date: formatNumber
                      };

                      // Use pivot data if available, otherwise create it from budget data
                      let budgetTableData;
                      if (result.budget_pivot && result.budget_pivot.length > 0) {
                          budgetTableData = result.budget_pivot;

                          // Create formatters for step columns
                          const pivotFormatters = {};
                          if (budgetTableData.length > 0) {
                              Object.keys(budgetTableData[0]).forEach(key => {
                                  if (key.match(/^\d+$/) || key.includes('Step')) {
                                      pivotFormatters[key] = formatCurrency;
                                  }
                              });
                          }

                          renderTable('budgetTable', budgetTableData, pivotFormatters);
                      } else {
                          // Fallback: create pivot table from budget data
                          budgetTableData = createPivotTable(result.budget || []);

                          // Find all step columns for pivot table
                          const stepColumns = {};
                          (result.budget || []).forEach(row => {
                              const step = `Step ${row.step || 0}`;
                              stepColumns[step] = formatCurrency;
                          });

                          const pivotFormatters = {
                              ...stepColumns
                          };

                          renderTable('budgetTable', budgetTableData, pivotFormatters);
                      }

                      renderTable('projectsTable', result.projects || [], projectFormatters);
                      renderTable('transactionsTable', result.transactions || [], transactionFormatters);

                      // Show raw JSON
                      responseContent.textContent = JSON.stringify(result, null, 2);
                      responseContent.classList.remove('text-red-500');
                      responseContent.classList.add('text-green-600');

                  } else {
                      // Show error in raw JSON tab
                      tabContainer.classList.remove('hidden');
                      showTab('raw-json');
                      responseContent.textContent = JSON.stringify(result, null, 2);
                      responseContent.classList.remove('text-green-600');
                      responseContent.classList.add('text-red-500');
                  }

              } catch (error) {
                  tabContainer.classList.remove('hidden');
                  showTab('raw-json');
                  responseContent.textContent = `Error: ${error.message}`;
                  responseContent.classList.remove('text-green-600');
                  responseContent.classList.add('text-red-500');
              } finally {
                  // Reset button state
                  submitBtn.disabled = false;
                  submitBtn.textContent = '🚀 Run Simulation';
                  loadingIndicator.classList.add('hidden');
              }
          });
    </script>
